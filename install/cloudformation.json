{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "Environment": {
      "Description": "Environment Name: test, prod, or dev-USERNAME",
      "Type": "String",
      "AllowedPattern": "dev-.+|test|prod"
    },
    "IsDevEnv": {
      "Description": "True if this is a development environment, so eg. has no Route53 domain name. Environment name should start with 'dev-'.",
      "Type": "String",
      "AllowedPattern": "true|false"
    },
    "Domain": {
      "Description": "CloudFront domain for non-dev. Also defines S3 bucket names.",
      "Type": "String",
      "AllowedPattern": ".*touch-mapper.org"
    }
  },
  "Conditions": {
    "IsDevEnv": {
      "Fn::Equals": [
        {
          "Ref": "IsDevEnv"
        },
        "true"
      ]
    }
  },
  "Resources": {
    "Logs": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "AccessControl": "LogDeliveryWrite",
        "VersioningConfiguration": {
          "Status": "Suspended"
        },
        "BucketName": {
          "Fn::Join": [
            ".",
            [
              {
                "Ref": "Environment"
              },
              "logs.touch-mapper"
            ]
          ]
        }
      }
    },
    "WebBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "WebsiteConfiguration": {
          "IndexDocument": "index.html",
          "ErrorDocument": "error.html"
        },
        "AccessControl": "PublicRead",
        "LoggingConfiguration": {
          "DestinationBucketName": {
            "Ref": "Logs"
          },
          "LogFilePrefix": "web/"
        },
        "VersioningConfiguration": {
          "Status": "Suspended"
        },
        "BucketName": {
          "Ref": "Domain"
        }
      }
    },
    "WebBucketRedirect": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "WebsiteConfiguration": {
          "RedirectAllRequestsTo": {
            "HostName": {
              "Ref": "Domain"
            }
          }
        },
        "AccessControl": "PublicRead",
        "LoggingConfiguration": {
          "DestinationBucketName": {
            "Ref": "Logs"
          },
          "LogFilePrefix": "webRedirect/"
        },
        "VersioningConfiguration": {
          "Status": "Suspended"
        },
        "BucketName": {
          "Fn::Join": [
            ".",
            [
              "www",
              {
                "Ref": "Domain"
              }
            ]
          ]
        }
      }
    },
    "MapsBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "WebsiteConfiguration": {
          "IndexDocument": "index.html"
        },
        "AccessControl": "PublicRead",
        "LoggingConfiguration": {
          "DestinationBucketName": {
            "Ref": "Logs"
          },
          "LogFilePrefix": "maps/"
        },
        "CorsConfiguration": {
          "CorsRules": [
            {
              "AllowedMethods": [
                "GET",
                "HEAD"
              ],
              "AllowedOrigins": [
                "*"
              ],
              "ExposedHeaders": [
                "x-amz-meta-processing-stage",
                "x-amz-meta-error-msg"
              ]
            }
          ]
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "ExpirationInDays": "180",
              "Id": "Delete after 180 days",
              "Prefix": "map/data/",
              "Status": "Enabled"
            }
          ]
        },
        "VersioningConfiguration": {
          "Status": "Suspended"
        },
        "BucketName": {
          "Fn::Join": [
            ".",
            [
              {
                "Ref": "Environment"
              },
              "maps.touch-mapper"
            ]
          ]
        }
      }
    },
    "StatsBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        },
        "VersioningConfiguration": {
          "Status": "Suspended"
        },
        "BucketName": {
          "Fn::Join": [
            ".",
            [
              {
                "Ref": "Environment"
              },
              "stats.touch-mapper"
            ]
          ]
        }
      }
    },
    "RequestsQueue": {
      "Type": "AWS::SQS::Queue",
      "Properties": {
        "DelaySeconds": "0",
        "MaximumMessageSize": "65536",
        "MessageRetentionPeriod": "300",
        "ReceiveMessageWaitTimeSeconds": "20",
        "VisibilityTimeout": "600",
        "QueueName": {
          "Fn::Join": [
            "-",
            [
              {
                "Ref": "Environment"
              },
              "requests-touch-mapper"
            ]
          ]
        }
      }
    },
    "RequestsSqsPolicy": {
      "Type": "AWS::SQS::QueuePolicy",
      "Properties": {
        "Queues": [
          {
            "Ref": "RequestsQueue"
          }
        ],
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": "*",
              "Action": [
                "SQS:GetQueueAttributes",
                "SQS:SendMessage"
              ],
              "Resource": {
                "Fn::GetAtt": [
                  "RequestsQueue",
                  "Arn"
                ]
              }
            }
          ]
        }
      }
    },
    "StatsAthenaDatabase": {
      "Type": "AWS::Glue::Database",
      "Properties": {
        "CatalogId": {
          "Ref": "AWS::AccountId"
        },
        "DatabaseInput": {
          "Name": {
            "Fn::Join": [
              "_",
              [
                "touch_mapper_stats",
                {
                  "Fn::Join": [
                    "_",
                    {
                      "Fn::Split": [
                        "-",
                        {
                          "Ref": "Environment"
                        }
                      ]
                    }
                  ]
                }
              ]
            ]
          }
        }
      }
    },
    "ApplicationStatsJsonTable": {
      "Type": "AWS::Glue::Table",
      "Properties": {
        "CatalogId": {
          "Ref": "AWS::AccountId"
        },
        "DatabaseName": {
          "Ref": "StatsAthenaDatabase"
        },
        "TableInput": {
          "Name": "application_stats_json",
          "TableType": "EXTERNAL_TABLE",
          "Parameters": {
            "EXTERNAL": "TRUE",
            "classification": "json",
            "projection.enabled": "true",
            "projection.year.type": "integer",
            "projection.year.range": "2024,2100",
            "projection.month.type": "integer",
            "projection.month.range": "1,12",
            "projection.month.digits": "2",
            "storage.location.template": {
              "Fn::Join": [
                "",
                [
                  "s3://",
                  {
                    "Ref": "StatsBucket"
                  },
                  "/stats-json/${year}/${month}/"
                ]
              ]
            }
          },
          "PartitionKeys": [
            {
              "Name": "year",
              "Type": "string",
              "Comment": "Partition key for UTC year derived from S3 object path."
            },
            {
              "Name": "month",
              "Type": "string",
              "Comment": "Partition key for UTC month derived from S3 object path."
            }
          ],
          "StorageDescriptor": {
            "Columns": [
              {
                "Name": "schema_version",
                "Type": "int",
                "Comment": "Version number of this telemetry record schema for backward-compatible query handling."
              },
              {
                "Name": "timestamp",
                "Type": "string",
                "Comment": "UTC time when the telemetry record was written in ISO 8601 format."
              },
              {
                "Name": "day",
                "Type": "string",
                "Comment": "UTC day-of-month component as two digits."
              },
              {
                "Name": "code_branch",
                "Type": "string",
                "Comment": "Git branch name parsed from deployed dist/VERSION.txt."
              },
              {
                "Name": "code_deployed",
                "Type": "string",
                "Comment": "Deployment tag payload parsed from package-* in deployed dist/VERSION.txt."
              },
              {
                "Name": "code_commit",
                "Type": "string",
                "Comment": "Git commit hash parsed from deployed dist/VERSION.txt."
              },
              {
                "Name": "request_id",
                "Type": "string",
                "Comment": "Full map request identifier received from the browser payload."
              },
              {
                "Name": "map_id",
                "Type": "string",
                "Comment": "Map identifier prefix derived from request_id before the slash."
              },
              {
                "Name": "status",
                "Type": "string",
                "Comment": "Terminal processing status such as success or failed."
              },
              {
                "Name": "failure_stage",
                "Type": "string",
                "Comment": "Pipeline stage active when processing failed, if any."
              },
              {
                "Name": "failure_class",
                "Type": "string",
                "Comment": "Exception class name captured on processing failure."
              },
              {
                "Name": "failure_message",
                "Type": "string",
                "Comment": "Exception message captured on processing failure."
              },
              {
                "Name": "termination_signal",
                "Type": "int",
                "Comment": "Termination signal number if the process received SIGTERM or SIGINT."
              },
              {
                "Name": "browser_fingerprint",
                "Type": "string",
                "Comment": "Hashed browser fingerprint used for approximate unique visitor estimation."
              },
              {
                "Name": "browser_ip",
                "Type": "string",
                "Comment": "Public client IP address reported by browser-side lookup when available."
              },
              {
                "Name": "browser_ip_country",
                "Type": "string",
                "Comment": "Country name resolved from browser_ip geolocation lookup."
              },
              {
                "Name": "browser_ip_country_code",
                "Type": "string",
                "Comment": "Country code resolved from browser_ip geolocation lookup."
              },
              {
                "Name": "browser_ip_region",
                "Type": "string",
                "Comment": "Region or state resolved from browser_ip geolocation lookup."
              },
              {
                "Name": "browser_ip_city",
                "Type": "string",
                "Comment": "City resolved from browser_ip geolocation lookup."
              },
              {
                "Name": "browser_ip_latitude",
                "Type": "double",
                "Comment": "Latitude resolved from browser_ip geolocation lookup."
              },
              {
                "Name": "browser_ip_longitude",
                "Type": "double",
                "Comment": "Longitude resolved from browser_ip geolocation lookup."
              },
              {
                "Name": "addr_long",
                "Type": "string",
                "Comment": "Full address label selected by the user."
              },
              {
                "Name": "printing_tech",
                "Type": "string",
                "Comment": "Selected printing technology mode such as 3d or 2d."
              },
              {
                "Name": "offset_x",
                "Type": "int",
                "Comment": "Map area X-offset in meters from the selected center."
              },
              {
                "Name": "offset_y",
                "Type": "int",
                "Comment": "Map area Y-offset in meters from the selected center."
              },
              {
                "Name": "size_cm",
                "Type": "double",
                "Comment": "Requested physical map size in centimeters."
              },
              {
                "Name": "content_mode",
                "Type": "string",
                "Comment": "Selected content mode: normal, no-buildings, or only-big-roads."
              },
              {
                "Name": "hide_location_marker",
                "Type": "boolean",
                "Comment": "Whether the location marker was omitted from the map."
              },
              {
                "Name": "lon",
                "Type": "double",
                "Comment": "Requested map center longitude sent by browser."
              },
              {
                "Name": "lat",
                "Type": "double",
                "Comment": "Requested map center latitude sent by browser."
              },
              {
                "Name": "scale",
                "Type": "int",
                "Comment": "Requested map scale denominator used for conversion."
              },
              {
                "Name": "multipart_mode",
                "Type": "boolean",
                "Comment": "Whether multipart map mode was enabled by the user."
              },
              {
                "Name": "no_borders",
                "Type": "boolean",
                "Comment": "Whether map border geometry generation was disabled."
              },
              {
                "Name": "multipart_xpc",
                "Type": "int",
                "Comment": "Multipart horizontal offset as percent of map diameter."
              },
              {
                "Name": "multipart_ypc",
                "Type": "int",
                "Comment": "Multipart vertical offset as percent of map diameter."
              },
              {
                "Name": "advanced_mode",
                "Type": "boolean",
                "Comment": "Whether advanced UI options were enabled for this request."
              },
              {
                "Name": "timing_get_osm_seconds",
                "Type": "double",
                "Comment": "Elapsed seconds spent downloading OSM data."
              },
              {
                "Name": "timing_map_desc_seconds",
                "Type": "double",
                "Comment": "Elapsed seconds spent generating map description metadata."
              },
              {
                "Name": "timing_svg_to_pdf_seconds",
                "Type": "double",
                "Comment": "Elapsed seconds spent converting SVG to PDF."
              },
              {
                "Name": "timing_total_seconds",
                "Type": "double",
                "Comment": "Total elapsed seconds from request pickup to terminal state."
              },
              {
                "Name": "timing_failed_after_seconds",
                "Type": "double",
                "Comment": "Elapsed seconds until failure for failed attempts, otherwise null."
              },
              {
                "Name": "stl_bytes",
                "Type": "bigint",
                "Comment": "Uncompressed byte size of the generated STL artifact."
              },
              {
                "Name": "stl_gzip_bytes",
                "Type": "bigint",
                "Comment": "Gzipped byte size of the generated STL artifact."
              },
              {
                "Name": "map_content_gzip_bytes",
                "Type": "bigint",
                "Comment": "Gzipped byte size of map-content JSON after request metadata attachment."
              },
              {
                "Name": "osm_fetched_bytes",
                "Type": "bigint",
                "Comment": "OSM XML byte size on disk immediately after fetch and before content-mode pruning."
              },
              {
                "Name": "osm_pruned_bytes",
                "Type": "bigint",
                "Comment": "OSM XML byte size on disk after content-mode pruning/filtering."
              },
              {
                "Name": "rss_osm2world_kib",
                "Type": "bigint",
                "Comment": "Maximum RSS in KiB for run-osm2world stage from osm-to-tactile-timings.json (/usr/bin/time -v)."
              },
              {
                "Name": "rss_blender_kib",
                "Type": "bigint",
                "Comment": "Maximum RSS in KiB for run-blender stage from osm-to-tactile-timings.json (/usr/bin/time -v)."
              },
              {
                "Name": "rss_clip_2d_kib",
                "Type": "bigint",
                "Comment": "Maximum RSS in KiB for run-clip-2d stage from osm-to-tactile-timings.json (/usr/bin/time -v)."
              },
              {
                "Name": "rss_prune_only_big_roads_kib",
                "Type": "bigint",
                "Comment": "Maximum RSS in KiB for prune-only-big-roads.js subprocess in content_mode=only-big-roads (/usr/bin/time -v)."
              }
            ],
            "Location": {
              "Fn::Join": [
                "",
                [
                  "s3://",
                  {
                    "Ref": "StatsBucket"
                  },
                  "/stats-json/"
                ]
              ]
            },
            "InputFormat": "org.apache.hadoop.mapred.TextInputFormat",
            "OutputFormat": "org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat",
            "SerdeInfo": {
              "SerializationLibrary": "org.openx.data.jsonserde.JsonSerDe",
              "Parameters": {
                "ignore.malformed.json": "true"
              }
            }
          }
        }
      }
    },
    "WebBucketS3Policy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {
          "Ref": "WebBucket"
        },
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:GetObject",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:s3:::",
                    {
                      "Ref": "WebBucket"
                    },
                    "/*"
                  ]
                ]
              }
            }
          ]
        }
      }
    },
    "CloudFront": {
      "Type": "AWS::CloudFront::Distribution",
      "Properties": {
        "DistributionConfig": {
          "Aliases": [
            {
              "Ref": "Domain"
            },
            {
              "Fn::Join": [
                "",
                [
                  "*.",
                  {
                    "Ref": "Domain"
                  }
                ]
              ]
            }
          ],
          "Enabled": true,
          "PriceClass": "PriceClass_All",
          "Origins": [
            {
              "Id": "web",
              "DomainName": {
                "Fn::Select": [
                  "2",
                  {
                    "Fn::Split": [
                      "/",
                      {
                        "Fn::GetAtt": [
                          "WebBucket",
                          "WebsiteURL"
                        ]
                      }
                    ]
                  }
                ]
              },
              "CustomOriginConfig": {
                "OriginProtocolPolicy": "http-only"
              }
            },
            {
              "Id": "maps",
              "DomainName": {
                "Fn::GetAtt": [
                  "MapsBucket",
                  "DomainName"
                ]
              },
              "S3OriginConfig": {}
            }
          ],
          "DefaultRootObject": "index.html",
          "DefaultCacheBehavior": {
            "TargetOriginId": "web",
            "ViewerProtocolPolicy": "redirect-to-https",
            "DefaultTTL": 3600,
            "MinTTL": 3600,
            "MaxTTL": 3600,
            "Compress": true,
            "AllowedMethods": [
              "HEAD",
              "GET",
              "OPTIONS"
            ],
            "CachedMethods": [
              "HEAD",
              "GET"
            ],
            "ForwardedValues": {
              "QueryString": false,
              "Headers": [
                "Origin"
              ],
              "Cookies": {
                "Forward": "none"
              }
            }
          },
          "CacheBehaviors": [
            {
              "TargetOriginId": "maps",
              "PathPattern": "/map/*",
              "ViewerProtocolPolicy": "allow-all",
              "MinTTL": 0,
              "AllowedMethods": [
                "HEAD",
                "GET",
                "OPTIONS"
              ],
              "CachedMethods": [
                "HEAD",
                "GET"
              ],
              "ForwardedValues": {
                "QueryString": false,
                "Cookies": {
                  "Forward": "none"
                }
              }
            }
          ],
          "HttpVersion": "http2",
          "ViewerCertificate": {
            "Fn::If": [
              "IsDevEnv",
              {
                "CloudFrontDefaultCertificate": true
              },
              {
                "AcmCertificateArn": "arn:aws:acm:us-east-1:730535225693:certificate/9dbd7fe0-68f5-4973-8d3a-b95623e476db",
                "SslSupportMethod": "sni-only"
              }
            ]
          },
          "Logging": {
            "Bucket": {
              "Fn::GetAtt": [
                "Logs",
                "DomainName"
              ]
            },
            "Prefix": "webCloudFront/"
          }
        }
      }
    },
    "EmailSendingRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "EmailSendingPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ses:SendEmail"
                  ],
                  "Resource": [
                    "*"
                  ]
                }
              ]
            }
          }
        ]
      }
    },
    "EmailSendingLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Handler": "lambda-email-sending.lambda_handler",
        "Role": {
          "Fn::GetAtt": [
            "EmailSendingRole",
            "Arn"
          ]
        },
        "Code": {
          "S3Bucket": {
            "Fn::Join": [
              ".",
              [
                {
                  "Ref": "Environment"
                },
                "internal.touch-mapper"
              ]
            ]
          },
          "S3Key": "lambda-email-sending.zip"
        },
        "Runtime": "python2.7",
        "Timeout": "10"
      }
    }
  },
  "Description": "Create Touch Mapper resources",
  "Outputs": {
    "cloudFrontDomainName": {
      "Value": {
        "Fn::GetAtt": [
          "CloudFront",
          "DomainName"
        ]
      }
    },
    "WebBucketUrl": {
      "Value": {
        "Fn::GetAtt": [
          "WebBucket",
          "WebsiteURL"
        ]
      }
    },
    "mapsBucket": {
      "Value": {
        "Fn::GetAtt": [
          "MapsBucket",
          "DomainName"
        ]
      }
    },
    "statsBucket": {
      "Value": {
        "Ref": "StatsBucket"
      }
    },
    "statsAthenaDatabase": {
      "Value": {
        "Ref": "StatsAthenaDatabase"
      }
    },
    "statsAthenaTable": {
      "Value": "application_stats_json"
    },
    "requestsQueue": {
      "Value": {
        "Ref": "RequestsQueue"
      }
    }
  }
}
